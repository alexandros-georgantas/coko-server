version: '3'

services:
  server:
    build:
      context: .
      dockerfile: Dockerfile-development
    depends_on:
      - db
      - filehosting
      - createbucket
    entrypoint:
      [
        'node_modules/.bin/wait-for-it',
        'db:5432',
        '--',
        'sh',
        'dev/scripts/setupDevServer.sh',
      ]
    command:
      [
        'node_modules/.bin/nodemon',
        './dev/startServer.js',
        '--watch',
        'src',
        '--watch',
        'dev',
        '--watch',
        'authorization',
        '--ext',
        'js,graphql',
      ]
    ports:
      - ${SERVER_PORT:-3000}:${SERVER_PORT:-3000}
    environment:
      - NODE_ENV=development
      - POSTGRES_HOST=db
      - POSTGRES_PORT=${POSTGRES_PORT:-5432}
      - POSTGRES_DB=${POSTGRES_DB:-test_db}
      - POSTGRES_USER=${POSTGRES_USER:-test_user}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-password}
      - PUBSWEET_SECRET=${PUBSWEET_SECRET:-theSecret}
      - SERVER_PORT=${SERVER_PORT:-3000}
    volumes:
      - ./dev:/home/node/app/dev
      - ./src:/home/node/app/src
      - ./authorization:/home/node/app/authorization

  db:
    extends:
      file: docker-compose.common.yml
      service: db

  filehosting:
    extends:
      file: docker-compose.common.yml
      service: filehosting

  createbucket:
    extends:
      file: docker-compose.common.yml
      service: createbucket

volumes:
  minio_storage:
